#07 Multi-dimensional Modelling
##一、多维建模初步
###1.事实表  
维度建模的核心和基本表

* 每一个事实表对应一个或多个度量值
	* 度量值是事实表的核心，也是分析的对象
	* 通过事实表记录维度与度量值的关系
* 一行对应一个度量值
	* 所有度量值必须具有相同粒度
	* 粒度划分模型
		* 事务
		* 周期快照
		* 累积快照
* 最常用的度量值：数值类型  
通常是可以连续取值的量，很少采用文本形式的度量值
* 三种类型的度量值
	* 可加型度量值  
	当前的所有度量值沿着事实表周边的维表，所有维成员相加得到的值有意义  
	通常有良好的意义
	* 可沿着某些维度做加法运算  
	一般是对一个水平的衡量
	* 不可做加法运算的度量值  
	一般不会出现，如果出现，要考虑是否没找到所有维度，或是事实表的设计有没有问题
		* 计数
		* 计算平均值
		* 取样统计
* 事实表中的关键字  
每个事实表都有两个或两个以上的外关键字
	* 外关键字建立了事实表与维表之间的联系，从而可以通过维度表来存取事实表中的度量值
	* 一般不需要显式主键  
	事实表通常没有查询的需求，添加主键造成的空间消耗没有任何产出  
	由外关键字的组合构成主键
###2.维度表
* 访问需要在上下文环境中进行，维度表就用来提供上下文
* 维度属性通常用于定义事实表的查询条件，也可以作为定义报表和统计查询的列  
列越多，维度表的能力就越大，查询就越强大
* 维度表的定义包括
	* 尽可能多的列
	* 相对事实表相对少的行  
	正因为规模远小于事实表，所以尽可能多的列不会造成大量的空间消耗
* 维属性
	* 通常是文本或离散数据  
	虽然有更多的数值类型分析手段，但对于真实分析人员来讲，文本数据会更加敏感  
	编码属性要尽量减少使用
	* 维属性与度量值的区别
		* 度量值有许多取值并参与统计运算
		* 离散的取值或可能不多，取值很少变化，不参与统计计算但用作查询条件
###3.事实与维度的融合
* 星形模型
* 雪花模型
* 数据立方体
##二、案例一：零售营销
###1.维度建模的设计过程
####选取要建模的分析型业务处理过程
获取分析的需要
####定义业务处理的粒度
根据数据仓库的建设情况，决定业务处理的粒度  
最小粒度与操作型数据库一致，但特殊情况下也会提升
####选择事实表中的维度
公共维度优先于所有维度被建立起来
####选择事实表中的度量值
* 以分析对象为依据
* 可以有多个度量值
###2.分析需要
####数据驱动的设计来源——数据入口
* 前台POS机
* 后台货物入库
####面向主题的设计来源——管理决策的需要
* 定价
* 促销  
避免货损与大量仓储空间的占据
###3.选取业务处理
*在什么促销条件下，在什么日子里，在什么商店正在销售怎么样的商品？*  
虽然很粗糙，但只能如此说明需求，因为还无法被描述出来
###4.定义粒度
案例中不考虑硬件限制，这里选择POS事务中的单个商品条目
###5.选定维度
日期、产品、商场、促销状态  
事实待定
###6.确定事实
销售量、销售额、成本额、毛利润金额

* 通过计算获得的可加性度量值也可以物理存储在事实表中  
如这里的毛利润金额  
**导出性属性是否需要存储，要考虑此属性是否会在今后因频繁访问而提高访问效率**
* 不具备可加性的计算结果应该由分析展现工具在访问过程中计算  
如毛利率、单价等  
*不可加指标放置为事实也没有作用，即使此属性被重复访问，也仍然需要继续计算*  
但非导出的不可加度量值就必须存储
###7.维度设计*
本质上不应该在这里讨论，**应该在建立多维模型之前就被确定**，这里为了讲课方便起见放在这里讲
####日期维度
* 基本是每个数据仓库必须具备的
* 可以预先放置5~10年的维度值
* 要尽可能多地包含属性
	* 日期关键字
	* 友好描述
	* 星期
	* 日历日期编号
	* 日历周结束日期
	* 财政年月
	* 重大事件
	* SQL日期标记
	* ……
	* 只要有需求，就可以任意添加  
	冗余也没有关系，不会占用太大的空间
* 实现时，日期关键字要按序排列  
这对今后的分片会非常有利
* 关键字使用数值类型  
省空间，连接操作也更快
* 维度值**全部都是非数值类型**
数据仓库的分析人员未必与开发人员具有相同知识背景，因此不允许使用编码类型（*包括编码类型*）
####产品维度
* 同样地列出尽可能多的属性  
* 此时无法再预先放置维度值  
因此产品关键字很可能就是无序的
* 很多属性之间存在关联
* 产品关键字不能保序，但仍然要用数值类型
#####产品维度表中的两类属性
* 多级体系划分属性  
SKU编号——小类描述——大类描述——部门描述  
从左到右都是多对一的对应关系，构成商品的分类体系
* 其它描述属性  
可以与体系划分属性组合在一起进行有意义的分析应用

两种属性的钻取能力不同，设计时可以尽量关注
####商场维度
* 销售面积是无法用文本描述的数值类型，并且还具备可加性  
销售面积只能认为是商场维度的一个属性值，而商场并不是分析模型的中心
* 首次开业日与重修日期的取值应来自日期维度表上的视图  
采用维度支架加以实现
####促销维度
#####对商品促销活动的评判因素
* 促销商品的销售分析
	* 在促销期间是否出现增长
	* 在促销进行之前或随后是否减少
* 相邻或同类其它商品的销售是否出现降低情况
* 同类商品的总体销售是否增长
* 促销是否盈利
#####维度设计
存在多种不同的促销形式  
每种促销活动可以单独形成一个促销维度表，也可以将所有促销活动糅合在一个促销维度表中  
反规范化的合并会浪费空间，反之会节约空间
######维度的组合与分散
* 组合
	* 参与组合的维度高度将官，组合起来的维度就不会比分开大太多
	* 组合的维度浏览更高效
	* 非排他性的维度倾向于融合
* 分散
	* 用户分开考虑时，分开的维度更容易理解
	* 独立维度的管理更加直接

**不在促销范围内的商品销售，事实表中不应当定义为NULL，而需要在促销维度表中定义一个特殊行**
###8.非事实型事实表——促销事务
*什么样的促销产品还没有卖出去*无法被回答

需要另外一个非事实型事实表来记录促销活动   
以几个维度的组合来表明促销活动的**存在**情况

* 非事实性  
没有有意义的实时信息，索性就没有度量值  
维度的组合已经说明一切  
非事实型事实表不能单独用来分析，但可以作为其它事实表的补充，协助进行分析
###9.退化维度——POS事务编号
本质上来说是一个维度，但这是一个**退化维度**，直接存放在事实表中  
原因是此维度的其它信息被拆分到了其它维度中去，但是还*不能丢弃*

* POS事务编号用于分组，丢弃后某些分析应用无法进行
* 如果发现某些异常，需要借此**反向连接**操作型数据环境
###10.再说一句
*这只是一个臆想模型*
###11.模型的演化
演化因数据仓库的迭代开发而不可避免

* 新的维度属性  
可能是遗漏的属性，或是新增的  
例如产品的全新描述属性  
**加入时间点前没有相应数据的，使用“不可用”进行填充**
* 新的维度  
例如会员、店员、日间时间等分析的角度  
	* 新的维表
	* 在事实表中添加新的外键
* 新的度量值事实
	* 添加新的度量值属性
	* 需要考虑事实表粒度  
	新事实的粒度与原有粒度不一致时，需要创建一个新的多维模型
* 维度变得具有更多粒度性
	* 建立新粒度层次上的维表  
	* 可能带来新粒度层次上的事实表，从而需要同时建立新的维度表和事实表
* 全新数据源的加入  
同时牵涉现存的维度和不能预见的新维度

*事实表的粒度设计将影响到是否易于加入新的维度*
###12.维度的规范化处理
* 设计时使用雪花模型，实际使用星形模型足矣
* 同时要避免过多地使用维度，产生**蜈蚣状事实表**  
一方面没有意义，人为打破了属性之间的关联，另一方面，事实表每增加一个外键需要消耗大量空间，人类也无法理解
####维度表中关键字的设计
* 代理关键字，避免直接使用操作型数据作为维度表和事实表的主键和外键  
例如，产品的SKU编号不允许直接作为关键字使用，学号也不允许直接作为学生的关键字
	* 缓冲操作性数据的变化对数据仓库数据的影响  
	操作型数据环境中，我们无法确保自然关键字保持稳定不变；	一旦发生修改，可以避免修改整个数据仓库的风险
	* 性能优势  
	自然关键字为字符类型时尤其明显
	* 操作型数据可能无法成为关键字  
	纸质单据的重复编号
	* **日期维度的特殊要求**  
	还需要表示一些特殊的日期（未知、永不发生等等）
	* 历史一致性
###13.市场篮子分析
* 不使用OLAP或者数据挖掘工具
* 事实表的抽取  
从零售营销事实表中抽取形成新的事实表，以实现新的分析应用
> ######例：商品促销活动实施情况分析
> * 产品数量过多，组合数量庞大  
> 解决方式为采用**领域知识支持**，或进行**层次式分析**
