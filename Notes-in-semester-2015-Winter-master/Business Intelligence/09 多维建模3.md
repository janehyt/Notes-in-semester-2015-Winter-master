#09 Multi-dimensional Modelling
##四、案例三：订单管理
###1.订单管理的引入
* 关注的业务处理流程  
报价、生成订单、安排生产计划、组织货物的装运发送、票据处理  
这些环节都是值链的一部分，都会产生有价值的分析数据，对应一个分析系统
* 关注的分析对象
	* 数量：订购，生产，装运……
	* 收入：订购额，贴现额，净订购额……
* 最基本的订单事务事实表  
为每个订单分列项建立一个记录行  
包含**订购量、增值总额、贴现金额、增值余额**等度量值
###2.事实表规范化方面的考虑
####事实表的规范化
将一张事实表中的多个度量值分解组装成多个事实表
####事实表规范化的目的
在对事实表进行规范后，可以连同标识事实类型维度一起得到单一的一般性事实
####规范化的时机
* 事实行的事实设置比较稀疏  
各事实之间是排他的，多个度量值不能同时有效  
*大多数适度粒度的事实表不存在此问题*  
*规范化后的事实表，空间开销会增大，时间开销也未必会减小*
* 不在事实之间施加运算
####结论
* 一般不考虑事实表的规范化  
除非不同度量值的计算处于不同的粒度层次，此时需要将它们分解到不同的事实表中去  
	> ######例：
	> 订单折扣无法细化到分列项事实中去

* 如果可以将粗粒度的度量值分配到细粒度层次上，那么可以在细粒度层次上统一粒度层次来建立一张统一的事实表
###3.维度设计策略
* 可以与之前的其他维度模型共享一组公共的维度表  
日期维、产品维、顾客维……
####需要考虑的其它问题
#####日期维度的角色模仿
* 订单管理事实表中存在多个日期维度  
每一个日期关键字都对应订单处理过程中的某个业务处理步骤
* 实现方式
	* 为每个日期类型的外键建立一个独立的日期维表  
	几乎所有事实表都存在日期维度，每个日期维度都单独存放浪费空间，时间上也有浪费，没有必要  
	因此不太可能使用
	* 所有日期类型的外键共享同一个物理的日期维表
	* 单个维度同时在同一个事实表出现几次，建立多组合的维度  
	节省了连接的时间，但无法进行演化，添加维度变得非常困难
	* **角色模仿**  
	后台只维持一个单一的日期维度表  
	为事实表中的每一个日期外键建立一个日期维表上的**视图**  
	日期维度在单个事实表中承担不同角色  
	可以降低存储空间开销，同时方便使用
#####维度表的属性体系结构
* 一张维表中存在若干组用于描述元组在不同方面的描述属性
* 在许多非体系属性之外，存在一个或而多个属性体系结构
* 将星形模型转化为雪花模型  
能够通过子维度作为公共维度连接多个多维模型的，应当充分考虑维度的规范化
	* 当前维表中有一小部分是公共维度时，可以考虑转化  
	* 维表的大小不能承受时，可以考虑转化
#####收货顾客维度
######营销代表使用合并维度还是独立维度
取决于当前营销代表的信息与商业定义

* 营销代表依附于收货地址维度时，应当合并维度
* 营销代表与顾客关系不固定时，应当将维度分离

结论：

* 当实体间存在固定的、不随时间变化的、强烈相关的关系时，需要作为单一维度进行建模
* 其它情况下需要分割
* 需要考虑维度过多的情况  
#####交易维度
如果期限、打折等交易信息存在相关，则组合成一个维度
#####订单编号退化维度
* 来源于操作型数据环境的订单细节已经从订单标题中剥离出来，形成独立的维度  
订单日期、收货顾客地址等等  
不能是度量值，但订单号也不能合并到某一维度中去  
*如果无用，可以丢弃*
* 订单编号用于对订单分列项进行分组，因此仍然有效  
哪些货物在同一个订单中？->货物之间的关联关系
* 偶用于数据库反向连接操作型领域
#####杂项维度
* 从复杂数据源中提取与事实、维度相关字段后往往还有大量在小范围内选取离散值的指示符和标志
	* 不加改变地保留在事实表行中？  
	事实表膨胀
	* 放在本身的单独维度中？  
	维度膨胀
	* 全部剥离？  
	删除难以理解的、杂乱的、或者与分析操作无关的属性  
	当前分析任务中需要这些信息的场合极少
* 也可以将它们组合成一个或多个独立的杂项维度表（*junk dimension*）  
在一定的开销下完成标志位的存放和处理
* 预先为所有组合创建维度行还是为实际遇到的组合创建杂项维度行  
由于杂项维度本身也不多，因此全部创建并不会浪费太大空间
* 杂项维度可以维护依附在事实行上的**自由注释字段**  
	* 参数化自由注释字段
	* 自由注释的数量远小于事实行  
	需要引入非注释行的代理关键字
###4.事实表的设计策略
####多种流通货币
使用分析工具与展现工具进行转换，转换的过程是固定的，但实际上，很多转换*并不是*固定的

* 选择一个标准货币，建立其与其它货币的转换关系
	* 不同货币间的汇率随时间变化
	* 货币之间的互兑汇率不尽相同
* 建立货币转换事实表  
存放历史所有货币的汇率信息
* 建立货币维表  
货币与国家间未必一一对应，因此货币与国家不能合并维度
* 订单事实表中需要保存标准货币和本地货币两套订单额  
避免转换产生的误差
####粒度不同的标题与分列项事实
* 订单的运费  
仅适用于整份订单
#####处理方法
* 在较低层次事实表中尽可能包含所有可用的高层事实表中的事实  
向下分摊
* 将运费与其他标题级事实展现在用于整个订购的聚集表中
####发票事务
#####（装运）发票的内容  
发货日期、目的地、顾客、发票总额

* 具有多个分列项  
对应着发送的不同商品  
不同的分列项有不同的数量、价格、贴现与打折等内容
#####发票事实表的设计
* 建立对应各个分列项的事实
* 新的维度：发货，货运人，顾客满意度
####支持多计量单位的事实表
零售、装运、托台、汽车等转换因子

* 与度量衡和货币等不同，这里的转换不受其它维度影响  
只和度量值相关
* 业务范围内的不同职能机构想看到以不同计量单位表示的相同性能指标
* 将所有事实与不同计量单位之间的转换因子存放在**同一个事实表**中
* 不同因子对应不同流程中的转换
* 因子一般不作为维度属性，而是封装在事实表中  
用户接口中看到的是因子乘积组合的结果
###5.事实表模型的比较
####事务粒度
* 代表一个时间点
* 每个事务事件一条记录
* ETL时进行插入操作
* 事实行发生更新时不重新存取
* 日期维度代表事务发生日期
* 事实是事务活动
####周期快照粒度
* 代表规律性、可预见的间隔
* 每段时间间隔一条记录
* ETL时进行插入操作
* 事实行发生更新时不重新存取
* 日期维度代表时间段的终止日期
* 事实是预定时间间隔的性能
####累积快照粒度
* 代表一个不确定的时间跨度  
通常是短期
* 每个生命期一条记录
* ETL时进行插入与更新操作
* 行为发生任何时候都要重新存取
* 包含标准关键环节的多个日期维度
* 事实是给定生命期的性能
###6.数据仓库的实时分区
* 在数据仓库环境中，存在对实时业务数据的访问需求  
因此在常规静态数据仓库的前面建立一个物理的**实时分区**  
* 功能和作用等同于数据仓库中的各个主题
* 对读写的效率都有要求  
在不停地修改
####对实时分区的约束要求
* 包括静态数据仓库最后一次更新以来出现的所有行为
* 尽可能无缝地连接到静态数据仓库事实表的粒度与内容上
* 能够轻松地建立索引，以总是可以不断吸纳新来的数据  
不能影响效率
####三种不同类型的实时分区
应当与数据仓库中的事实表类型一致，这样才能实现无缝拼接，也便于在ETL时进行处理
#####事务粒度  
当天的记录，并非统计结果，提供很快加载性能的同时提供快速的查询性能

* 丢弃导出值
* 可能完全不建立索引  
效率考虑，实时分区中的数据量并未大到需要索引提到查询效率的程度
* 避免包含聚集值  
进行冗余数据的增删改时，需要对所有数据复本同步进行操作，也会影响效率
#####周期快照
* 实时分区可以看作数据仓库事实表当前的热积月
* 实时分区是当前正在开发的月份的映像，随月份的推进不断更新  
半加性或全加性事实随报表不断调整
* 月份结束时累计起来的实时分区作为最新月份加载到静态仓库
#####累积快照
与事务快照十分类似

* 仅包含当天更新的分列项
* 当天结束时，实时分区包含需要写到主要事实表上记录的最新版本
* 无需索引和聚集